// Import required modules
import { writeFileSync, mkdirSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import fetch from 'node-fetch';

// Enable better error handling
process.on('unhandledRejection', (reason, promise) => {
  console.error('Unhandled Rejection at:', promise, 'reason:', reason);
  process.exit(1);
});

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// Configuration
const MODRINTH_USERNAME = 'vwtfafa'; // Your Modrinth username
const MODRINTH_API = 'https://api.modrinth.com/v2';
const PROJECTS_DIR = join(__dirname, '../../src/data');
const PROJECTS_FILE = join(PROJECTS_DIR, 'projects.js');

// Get project type from Modrinth project type
function getProjectType(projectType) {
  const types = {
    'mod': 'mod',
    'modpack': 'modpack',
    'plugin': 'plugin',
    'resourcepack': 'resourcepack'
  };
  return types[projectType] || 'other';
}

// Get project status based on last updated date
function getProjectStatus(lastUpdated) {
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
  
  const updatedDate = new Date(lastUpdated);
  return updatedDate > thirtyDaysAgo ? 'active' : 'unsupported';
}

// Format project data for our frontend
function formatProject(project) {
  return {
    id: project.slug || project.id,
    name: project.title,
    type: getProjectType(project.project_type),
    description: project.description,
    longDescription: project.description, // Modrinth doesn't provide a separate long description
    lastUpdated: project.updated || project.published,
    status: getProjectStatus(project.updated || project.published),
    links: {
      modrinth: `https://modrinth.com/${project.project_type}/${project.slug || project.id}`,
      github: project.source_url?.includes('github.com') ? project.source_url : null,
      download: project.downloads_url
    },
    tags: [
      ...(project.versions || []).slice(0, 2), // Show up to 2 Minecraft versions
      ...(project.categories || []).slice(0, 3) // Show up to 3 categories
    ].filter(Boolean)
  };
}

// Main function to sync projects
async function syncModrinthProjects() {
  try {
    console.log('Fetching projects from Modrinth...');
    
    // Get user ID from username
    const userRes = await fetch(`${MODRINTH_API}/user/${MODRINTH_USERNAME}`);
    if (!userRes.ok) throw new Error(`Failed to fetch user: ${userRes.statusText}`);
    const user = await userRes.json();
    
    // Get user's projects
    const projectsRes = await fetch(`${MODRINTH_API}/user/${user.id}/projects`);
    if (!projectsRes.ok) {
      const errorText = await projectsRes.text();
      throw new Error(`Failed to fetch projects: ${projectsRes.status} - ${errorText}`);
    }
    const projectIds = await projectsRes.json();
    
    if (!Array.isArray(projectIds)) {
      throw new Error(`Expected an array of project IDs, got: ${JSON.stringify(projectIds)}`);
    }
    
    console.log(`Found ${projectIds.length} projects to sync`);
    
    // Get detailed project information
    const projects = await Promise.all(
      projectIds.map(id => {
        if (typeof id !== 'string') {
          console.error(`Invalid project ID:`, id);
          return null;
        }
        return fetch(`${MODRINTH_API}/project/${id}`)
          .then(async res => {
            if (!res.ok) {
              const errorText = await res.text();
              console.error(`Failed to fetch project ${id}: ${res.status} - ${errorText}`);
              return null;
            }
            return res.json();
          })
          .catch(err => {
            console.error(`Error fetching project ${id}:`, err);
            return null;
          });
      })
    );
    
    // Filter out failed requests and format projects
    const formattedProjects = projects
      .filter(Boolean)
      .map(formatProject);
    
    // Sort by last updated (newest first)
    formattedProjects.sort((a, b) => 
      new Date(b.lastUpdated) - new Date(a.lastUpdated)
    );
    
    // Generate the projects.js file content
    const fileContent = `// Auto-generated by sync-modrinth.js

const projects = ${JSON.stringify(formattedProjects, null, 2)};

export default projects;`;
    
    // Ensure the directory exists
    try {
      mkdirSync(PROJECTS_DIR, { recursive: true });
    } catch (err) {
      console.error('Error creating projects directory:', err);
      process.exit(1);
    }
    
    // Write to file
    try {
      writeFileSync(PROJECTS_FILE, fileContent);
      console.log(`Successfully updated ${formattedProjects.length} projects in ${PROJECTS_FILE}`);
    } catch (err) {
      console.error('Error writing projects file:', err);
      process.exit(1);
    }
  } catch (error) {
    console.error('Error syncing Modrinth projects:', error);
    process.exit(1);
  }
}

// Run the sync
syncModrinthProjects();
